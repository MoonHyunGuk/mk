<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="statistics.aplcStats">

	<!-- 지로 신청 리스트 -->
	<select id="aplc" resultClass="java.util.HashMap">
	SELECT
		READNM AS USERNAME,
		DLVZIP AS ZIP,
		NVL2(BDMNGNO, FUNC_EXP_OLD_ADDR(BDMNGNO)||' '||DLVADRS2, DLVADRS1||DLVADRS2) AS ADDR,
		MOBILE1||'-'||MOBILE2||'-'||MOBILE3 AS HANDY ,
		CASE WHEN QTY IS NULL THEN 1 ELSE QTY END AS BUSU,
		(SELECT CNAME FROM TC_COMMON WHERE USEYN = 'Y' AND CDCLSF = '013' AND CODE=HJPATHCD) HJPATH,
		FUNC_AGENT_NM(BOSEQ) BONM
	FROM
		TM_READER_APLC
	WHERE
		BOSEQ IS NOT NULL
		AND NVL(DELYN, 'N') != 'Y'
		AND TO_CHAR(INDT,'YYYYMMDD') BETWEEN #fromDate# AND #toDate#
	</select>

	<!-- 카드 신청 리스트 -->
	<select id="card" resultClass="java.util.HashMap">
	SELECT
		USERNAME AS USERNAME,
		ZIP,
		NVL2(BDMNGNO, FUNC_EXP_OLD_ADDR(BDMNGNO)||' '||ADDR2, ADDR1||ADDR2) AS ADDR1,
		HANDY1||'-'||HANDY2||'-'||HANDY3 AS HANDY ,
		NVL(QTY, 1) BUSU,
		(SELECT CNAME FROM TC_COMMON WHERE USEYN = 'Y' AND CDCLSF = '013' AND CODE = '003') HJPATH,
		FUNC_AGENT_NM(BOSEQ) BONM
	FROM
		TBL_CARD_READER
	WHERE
		NVL(NEWYN, 'N') = 'Y'
		AND BOSEQ IS NOT NULL
		AND TO_CHAR(INDT,'YYYYMMDD') BETWEEN #fromDate# AND #toDate#
	</select>

	<!-- 교육용 독자 신청 리스트 -->
	<select id="edu" resultClass="java.util.HashMap">	
	SELECT
		A.READNM AS USERNAME ,
		A.DLVZIP AS ZIP,
		A.DLVADRS1||A.DLVADRS2 AS ADDR ,
		DECODE(A.MOBILE1, NULL, A.HOMETEL1||'-'||A.HOMETEL2||'-'||A.HOMETEL3
						, A.MOBILE1||'-'||A.MOBILE2||'-'||A.MOBILE3 ) AS HANDY ,
  		CASE WHEN A.QTY IS NULL THEN 1 ELSE A.QTY END AS BUSU,
  		(SELECT CNAME FROM TC_COMMON WHERE USEYN = 'Y' AND CDCLSF = '013' AND CODE=A.HJPATHCD) HJPATH,
  		FUNC_AGENT_NM(A.BOSEQ) BONM
	FROM
		TM_READER_NEWS A,
		TM_READER_EDUCATION B
	WHERE
    	A.READNO = B.READNO
  		AND A.BOSEQ IS NOT NULL
        AND A.READTYPECD = '015'
        AND B.MVYN IS NULL
		AND TO_CHAR(A.INDT,'YYYYMMDD') BETWEEN #fromDate# AND #toDate#
	</select>

	<!-- 자동이체 일반 신청 리스트 -->
	<select id="tbl" resultClass="java.util.HashMap">
	SELECT
		USERNAME,
		ZIP1 || '-' || ZIP2 AS ZIP,
		NVL2(BDMNGNO, FUNC_EXP_OLD_ADDR(BDMNGNO)||' '||ADDR2, ADDR1||ADDR2) AS ADDR,
		HANDY ,
		CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END AS BUSU,
		FUNC_AGENT_NM(REALJIKUK) BONM
	FROM
		TBL_USERS
	WHERE
		REALJIKUK IS NOT NULL
		AND RDATE IS NOT NULL
		AND NEWYN IS NOT NULL
		AND NEWYN = 'Y'
		AND TO_CHAR(INDATE,'YYYYMMDD') BETWEEN #fromDate# AND #toDate#
	</select>

	<!-- 자동이체 학생 신청 리스트 -->
	<select id="stu" resultClass="java.util.HashMap">
	SELECT
		USERNAME,
		ZIP1 || '-' || ZIP2 AS ZIP,
		NVL2(BDMNGNO, FUNC_EXP_OLD_ADDR(BDMNGNO)||' '||ADDR2, ADDR1||ADDR2) AS ADDR,
		HANDY ,
		CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END AS BUSU,
		FUNC_AGENT_NM(REALJIKUK) BONM
	FROM
		TBL_USERS_STU
	WHERE
		REALJIKUK IS NOT NULL
		AND RDATE IS NOT NULL
		AND NEWYN IS NOT NULL
		AND NEWYN = 'Y'
		AND TO_CHAR(INDATE,'YYYYMMDD') BETWEEN #fromDate# AND #toDate#
	</select>

	<!-- 일계, 월계, 누계 -->
	<select id="count" resultClass="java.util.HashMap">
  		SELECT
		(SELECT (CASE WHEN SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) IS NULL THEN 0 ELSE SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) end) FROM TBL_USERS WHERE REALJIKUK IS NOT NULL AND RDATE IS NOT NULL AND NEWYN IS NOT NULL AND NEWYN = 'Y' AND TO_CHAR(INDATE,'YYYYMMDD') BETWEEN #fromDate# AND #toDate#) +
		(SELECT NVL(SUM(CASE WHEN A.QTY IS NULL THEN 1 ELSE A.QTY END), 0) FROM TM_READER_NEWS A, TM_READER_EDUCATION B WHERE A.READNO = B.READNO AND A.BOSEQ IS NOT NULL AND A.READTYPECD = '015' AND B.MVYN IS NULL AND A.INDT BETWEEN #fromDate# AND #toDate#)+
		(SELECT NVL(SUM(CASE WHEN QTY IS NULL THEN 1 ELSE QTY END), 0) FROM TM_READER_APLC WHERE BOSEQ IS NOT NULL AND INDT BETWEEN #fromDate# AND #toDate# )+
		(SELECT NVL(SUM(CASE WHEN QTY IS NULL THEN '1' ELSE QTY END), '0') FROM TBL_CARD_READER WHERE NVL(NEWYN, 'N') = 'Y' AND BOSEQ IS NOT NULL AND INDT BETWEEN #fromDate# AND #toDate# ) SUMDAY,
		(SELECT (CASE WHEN SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) IS NULL THEN 0 ELSE SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) end) FROM TBL_USERS_STU WHERE REALJIKUK IS NOT NULL AND RDATE IS NOT NULL AND NEWYN IS NOT NULL AND NEWYN = 'Y' AND TO_CHAR(INDATE,'YYYYMMDD') BETWEEN #fromDate# AND #toDate# ) SUMDAYSTU,
		(SELECT (CASE WHEN SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) IS NULL THEN 0 ELSE SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) end) FROM TBL_USERS WHERE REALJIKUK IS NOT NULL AND RDATE IS NOT NULL AND NEWYN IS NOT NULL AND NEWYN = 'Y' AND TO_CHAR(INDATE,'YYYYMMDD') BETWEEN #year#||#month#||'01' AND #toDate# ) +
		(SELECT NVL(SUM(CASE WHEN A.QTY IS NULL THEN 1 ELSE A.QTY END), 0) FROM TM_READER_NEWS A, TM_READER_EDUCATION B WHERE A.READNO = B.READNO AND A.BOSEQ IS NOT NULL AND A.READTYPECD = '015' AND B.MVYN IS NULL AND A.INDT BETWEEN #year#||#month#||'01' AND #toDate# )+
		(SELECT NVL(SUM(CASE WHEN QTY IS NULL THEN 1 ELSE QTY END), 0) FROM	TM_READER_APLC WHERE BOSEQ IS NOT NULL AND INDT BETWEEN #year#||#month#||'01' AND #toDate# )+
		(SELECT NVL(SUM(CASE WHEN QTY IS NULL THEN '1' ELSE QTY END), '0') FROM TBL_CARD_READER WHERE NVL(NEWYN, 'N') = 'Y' AND BOSEQ IS NOT NULL AND INDT BETWEEN #year#||#month#||'01' AND #toDate# ) SUMMONTH,
		(SELECT	(CASE WHEN SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) IS NULL THEN 0 ELSE SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) end) FROM TBL_USERS_STU WHERE REALJIKUK IS NOT NULL AND RDATE IS NOT NULL AND NEWYN IS NOT NULL AND NEWYN = 'Y' AND TO_CHAR(INDATE,'YYYYMMDD') BETWEEN #year#||#month#||'01' AND #toDate# ) SUMMONTHSTU,
		(SELECT (CASE WHEN SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) IS NULL THEN 0 ELSE SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) end) FROM TBL_USERS WHERE REALJIKUK IS NOT NULL AND RDATE IS NOT NULL AND NEWYN IS NOT NULL AND NEWYN = 'Y' AND TO_CHAR(INDATE,'YYYYMMDD') BETWEEN #year#||'0101' AND #toDate# ) +
		(SELECT NVL(SUM(CASE WHEN A.QTY IS NULL THEN 1 ELSE A.QTY END), 0) FROM TM_READER_NEWS A, TM_READER_EDUCATION B WHERE A.READNO = B.READNO AND A.BOSEQ IS NOT NULL AND A.READTYPECD = '015' AND B.MVYN IS NULL AND A.INDT BETWEEN #year#||'0101' AND #toDate# )+
		(SELECT	NVL(SUM(CASE WHEN QTY IS NULL THEN 1 ELSE QTY END), 0) FROM TM_READER_APLC WHERE BOSEQ IS NOT NULL AND INDT BETWEEN #year#||'0101' AND #toDate# )+
		(SELECT NVL(SUM(CASE WHEN QTY IS NULL THEN '1' ELSE QTY END), '0') FROM TBL_CARD_READER WHERE NVL(NEWYN, 'N') = 'Y' AND BOSEQ IS NOT NULL AND INDT BETWEEN #year#||'0101' AND #toDate# ) SUMYEAR,
		(SELECT (CASE WHEN SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) IS NULL THEN 0 ELSE SUM(CASE WHEN BUSU IS NULL THEN '1' ELSE BUSU END) end) FROM TBL_USERS_STU WHERE REALJIKUK IS NOT NULL AND RDATE IS NOT NULL AND NEWYN IS NOT NULL AND NEWYN = 'Y' AND TO_CHAR(INDATE,'YYYYMMDD') BETWEEN #year#||'0101' AND #toDate# ) SUMYEARSTU
		FROM DUAL
	</select>

</sqlMap>